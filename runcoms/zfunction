function mutagen-create {
  name=$1
  alpha=$2
  beta=$3

  mutagen sync create \
    $alpha \
    $beta \
    -n $name \
    -l $name \
    -c $TU_DOCKER_BASE/mutagen.yml
}

function ssm-get {
  aws ssm get-parameter --name "$1" | jq -r .Parameter.Value
}

function watch-lambda {
  fn=$1
  shift
  saw watch --raw /aws/lambda/$fn "$@"
}

function watch-lambda-jq {
  fn=$1
  shift
  saw watch /aws/lambda/$fn --raw "$@" \
    | grep --line-buffered \
      -vE '(RequestId|INIT_START|FIREBASE WARNING|^$)' \
    | jq -R 'fromjson? | .'
}

function saw-jq {
  saw get "$@" \
    | grep --line-buffered \
      -vE '(RequestId|INIT_START|FIREBASE WARNING|^$)' \
    | jq -R 'fromjson? | .'
}

function get-lambda {
  fn=$1
  shift
  saw get /aws/lambda/$fn "$@" \
    | grep -vE '(RequestId|INIT_START)' \
    | grep -vE '^$'
}

# same as get-lambda except ignore bad JSON
function get-lambda-jq {
  fn=$1
  shift
  saw get /aws/lambda/$fn "$@" \
    | grep -vE '(RequestId|INIT_START)' \
    | grep -vE '^$' \
    | jq -R 'fromjson? | .'
}

function docker-shell {
  docker exec -it $1 bash
}

function docker-tail {
  while true; do 
    docker logs -f $1
    sleep 1
  done
}

function docker-run-shell {
  docker run --rm -it $1 /bin/bash
}

function docker-run {
  docker run --rm --name $1 $1
}

function ecr-login {
  local repo=$AWS_ECR_PRIVATE_REPO

  if [ "$1" = "public" ]; then
    local repo=$AWS_ECR_PUBLIC_REPO
  fi

  aws ecr get-login-password --region us-east-1 \
    | docker login --username AWS --password-stdin $repo
}

function rsync-watch {
  while true; do
    fswatch -o $1 | rsync -avz $1 $2
  done
}

function s3cat {
  aws s3 cp "$1" -
}

function lambda-invoke {
  aws lambda invoke \
    --function-name $1 \
    --payload $2 \
    --cli-read-timeout 300 \
    /tmp/out_$1
}

function napi-force-update {
  https --session=napi --ignore-stdin patch $NAPI_PRD_URL/devices/$1 \
    forceUpdate=$RANDOM
}

function napi-get-device {
  https --session=napi $NAPI_PRD_URL/devices/$1
}

function napi-update-device {
  local id=$1
  shift
  https --session=napi --ignore-stdin patch $NAPI_PRD_URL/devices/$id "$@"
}

function check-ssl {
  openssl s_client -connect $1:443 2>/dev/null | openssl x509 -noout -dates
}

function chrome-screenshot {
  chrome='/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'
  $chrome --disable-gpu --headless --screenshot $1
}

function unzip-to-dir {
  local dir=`basename $1 .zip`
  mkdir -p $dir
  unzip $1 -d $dir
}

function pg-select {
  psql $PG_PRD_URL -qAtc "$1"
}

function epoch-ms {
  date -r $(expr $1 / 1000)
}

function dcr {
  docker compose down -v "$1"
  docker compose up -d "$1"
}

